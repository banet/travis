<?php
	$content.='<style>.tabs .tab-title > a { padding: 1rem 0.75rem; }</style>';
	// get letter
	if (isset($_GET['letter'])){
	      $curletter=$_GET['letter'];
	} else { $curletter='A'; }

	// is it a search
	if (isset($_GET['q'])){
	      $searchValue=$_GET['q'];
	}

	global $alpha_chunks;
	# Initialize array
	$alpha_chunks = array();

	function chunkNames(&$value, $key, $letter) {
		global $alpha_chunks;

		/* If the first letter of the last name == $letter, Add the entry to a multi-dimensional array with each $letter is the key. */
		if ($value['course'][0] === $letter ) {
			$alpha_chunks[$letter][$key] = $value;
		}
	}

	$range = array('A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','R','S','T','V','W','Y');

	$DOCROOT= $_SERVER['DOCUMENT_ROOT'];
	$coursesFile = $DOCROOT.'/__shared/Pagelet22833.html';

	$json = file_get_contents($coursesFile);
	$coursesdata = json_decode($json, true);

	// put the file into arrays
	$data = $coursesdata['data'];
	if (!isset($searchValue)) {
		foreach($range as $letter) {
			# $array_to_walk isn't defined here, but this is should be the array you'd like to split.
			array_walk($data, 'chunkNames', $letter);
		}

		$content.='<ul class="tabs">';
		// create the A-Z tabs by stepping through the array of letters
		for ($i=0;$i<count($range);$i++) {
			if ($range[$i]==$curletter) { $active=' active'; } else { $active=''; }
			$content.='<li class="tab-title'.$active.'"><a href="courselist.php?letter='.$range[$i].'">'.$range[$i].'</a></li>';
		}
		$content.='</ul>';

		$content.='<div class="small-12">
		<p class="size-12 v1top">Sort any table by clicking on the column header.</p>
		<section role="tabpanel" aria-hidden="'.$hidden.'" class="content'.$active.'" id="tab-'.$curletter.'">
		<table class="small-12 resultsTable mTable">
			<caption class="v1bottom">Courses - '.$curletter.'</caption>
			<thead>
			<tr>
				<th data-sort="string" class="small-2">Title</th>
				<th data-sort="string" class="small-8">Name</th>
				<th data-sort="string" class="small-2">Delivery</th>
			</tr>
			</thead><tbody>';

		foreach ($alpha_chunks[$curletter] as $item) {
			$content.='<tr>
				<td data-th="Title">'.$item['course'].'</td>
				<td data-th="Name" class="small-12">
					<div class="accordion">
						<h6 class="accordion-toggle"><i class="fa fa-plus">&nbsp;</i>'.$item['name'].'</h6>
						<div class="accordion-content">
							<p><strong>'.$item['credits'].'</strong><br>
							'.$item['description'].'<br>
							'.$item['prerequisite'].'<br>
							'.$item['corequisite'].'<br>
							'.$item['exclusions'].'<br>
							'.$item['note'].'<br>
							'.$item['moreinfo'].'</p>
						</div>
					</div>
				</td>
				<td data-th="Delivery">'.$item['delivery'].'</td>
			</tr>';
		}

		$content.='</tbody></table></section></div>';
	} else {
		// this is a search, create an array for matches
            $matches = array();

		foreach ($data as $item) {
                  if ( preg_match('/'.$searchValue.'/i', ''.$item['course'].'') || preg_match('/'.$searchValue.'/i', ''.$item['name'].'') || preg_match('/'.$searchValue.'/i', ''.$item['description'].'') || preg_match('/'.$searchValue.'/i', ''.$item['moreinfo'].'') ) {
                        $matches[]=$item;
                  }
		}

            if (empty($matches)) {
                  $content.='<h2>Search Results for \''.$searchValue.'\'</h2>
                        <p>Sorry, there is no match for \''.$searchValue.'\'.</p>';
            } else {
                  $content.='<h2>Search Results for \''.$searchValue.'\'</h2>
                  <table class="small-12 resultsTable mTable">
                    <thead>
                    <tr>
                      <th data-sort="string" class="small-2">Title</th>
                      <th data-sort="string" class="small-8">Name</th>
                      <th data-sort="string" class="small-2">Delivery</th>
                    </tr>
                    </thead><tbody>';
                  foreach ($matches as $item) {
				$content.='<tr>
					<td>'.$item['course'].'</td>
					<td class="small-12">
						<div class="accordion">
							<h6 class="accordion-toggle"><i class="fa fa-plus">&nbsp;</i>'.$item['name'].'</h6>
							<div class="accordion-content">
								<p><strong>'.$item['credits'].'</strong><br>
								'.$item['description'].'<br>
								'.$item['prerequisite'].'<br>
								'.$item['corequisite'].'<br>
								'.$item['exclusions'].'<br>
								'.$item['note'].'<br>
								'.$item['moreinfo'].'</p>
							</div>
						</div>
					</td>
					<td>'.$item['delivery'].'</td>
				</tr>';
                  }
                  $content.='</tbody></table>';
            }
             $content.='<div class="clearfix"><a href="courselist.php" class="button tealbg nomargin radius">View all courses</a></div>';
	}
	// echo the content to the page
	echo $content;
?>
